---
title: "NHANES Data Exploration (Heavy Metal Exposure & High blood Pressure)"
author: 
  - name: "Sofiya Vyshnya"
date: last-modified
date-format: iso
toc: true
toc-location: left
number-sections: true
preview: images/research_preview.jpg   # optional thumbnail
lightbox: true
execute:
  echo: false
  warning: false
  message: false
---

# Central Hypothesis

My central hypothesis for this study is that middle-aged adults (age 40-65) adults with heavy metal exposure (e.g. lead exposure) have higher systolic blood pressure. To test this hypothesis, I am using data gathered from NHANES during the years of 2017-March 2020 (the pre-pandemic years). In this study (Study 1 analyses), I am performing data exploration to understand the distributions for each variable and investigate relationships between variables. 

# Import Helper Functions
```{r}
source(here::here("R/helpers.R"))  # absolute path to R/
```

# Setup and Data Ingest

The dataset consists of 2475 adults ages 40-65 participating in NHANES 2017-2020. The original NHANES data from 2017-2020 contained 9254 observations collected from individuals age 0-80. However, after selecting individuals aged 40-65, 2475 individuals were left.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(nhanesA)
suppressWarnings(library(dplyr))
library(tidyverse)
library(patchwork)

# Download three datasets
demo  <- nhanes("DEMO_J")   # demographics
pbcd  <- nhanes("PBCD_J")   # heavy metals (lead, cadmium, manganese) in blood
bpx   <- nhanes("BPX_J")    # blood pressure

# Merge them
nhanes_data <- Reduce(function(x, y) merge(x, y, by = "SEQN", all = TRUE),
                      list(demo, pbcd, bpx))

# Pull out only variables of interest
nhanes_subset <- nhanes_data %>%
  select(
    SEQN,       # participant ID
    RIDAGEYR,   # age
    RIAGENDR,   # gender
    RIDRETH1,   # race
    LBXBPB,     # blood lead
    LBXBCD,     # blood cadmium
    LBXBMN,     # blood manganese
    BPXSY1,     # systolic BP
    BPXDI1,     # diastolic BP
  )

# Filter for participants 18–65 years old 
nhanes_filtered <- nhanes_subset %>% 
  filter(RIDAGEYR >= 40, RIDAGEYR <= 65) %>%

  # Re-name "Other Race - Including Multi-Racial" category in RIDRETH1 to Exclude Prohibited Characters 
  mutate( 
    RIDRETH1 = fct_recode(RIDRETH1, "Other/Multiracial" = "Other Race - Including Multi-Racial") 
    )


# Save to RDS for later use
saveRDS(nhanes_filtered, here::here("data/nhanes_data.rds"))
```

# Data Cleaning

*General:* Individuals with missing data for any of the variables listed in Table 1 were removed.

*Numeric Variable Processing:* Outliers (defined as values \< Q1- 1.5*IQR or \> Q3+1.5*IQR) were removed. Numeric variables were subsequently log-transformed to make them approximately log-normal (see histograms below).

The resulting dataset has 1590 observations.

```{r, echo=TRUE, message=FALSE, warning=FALSE}

# Generate plots showing data distribution for all numeric variables. Show the original distribution, the distribution after removing outliers, and the distribution after log transforming the data. 
p_lead      <- visualize_data(nhanes_filtered, "LBXBPB", "Blood Lead")
p_cadmium   <- visualize_data(nhanes_filtered, "LBXBCD", "Blood Cadmium")
p_manganese <- visualize_data(nhanes_filtered, "LBXBMN", "Blood Manganese")

final_plot <- (p_lead / p_cadmium / p_manganese) # stacks plots for each variable on top of each other

final_plot



# Lab data: remove outliers and log normalize the data
numeric_vars <- c("LBXBPB", "LBXBCD", "LBXBMN")

nhanes_clean <- nhanes_filtered %>%
  # Remove outliers -> temporary "_clean" columns
  mutate(across(all_of(numeric_vars), remove_outliers, .names = "{.col}_clean")) %>%
  
  # Log-transform -> new "_log" columns
  mutate(across(ends_with("_clean"), ~log1p(.), .names = "{.col}_log")) %>%
  
  # Drop rows with NA values introduced by outlier removal
  drop_na()


# Blood pressure data: remove outliers but don't log transform (data already roughly Gaussian)
numeric_vars <- c("BPXSY1", "BPXDI1")

nhanes_clean <- nhanes_clean %>%
  # Remove outliers -> "_clean" columns
  mutate(across(all_of(numeric_vars), remove_outliers, .names = "{.col}_clean")) %>%
  
  # Drop rows with NA values introduced by outlier removal
  drop_na()

  
# Save cleaned data 
saveRDS(nhanes_clean, here::here("data/study1/nhanes_data_cleaned.rds"))
```

# Dataset Description and Codebook
```{r}
# Read in the cleaned data
nhanes_clean <- readRDS(here::here("data/study1/nhanes_data_cleaned.rds"))
```

## Dataset Description & Summary Statistics

Table 1: Variables included in the data.

| Variable | Description | Data Type |
|:-----------------------|:-----------------------|:-----------------------|
| **SEQN** | Subject ID: Individual Identifier | Quantitative (Integer) |
| **RIDAGEYR** | Age: Age in years at screening, range 40-65 | Quantitative (Integer) |
| **RIAGENDR** | Sex: male or female | Binary |
| **RIDRETH1** | Race | Multi-level Categorical |
| **LBXBPB** | Blood lead (µg/dL) | Quantitative (Continuous) |
| **LBXBPB_clean_log** | Blood lead after outlier removal and log transformation | Quantitative (Continuous) |
| **LBXBCD** | Blood cadmium (µg/dL) | Quantitative (Continuous) |
| **LBXBCD_clean_log** | Blood cadmium (µg/dL) after outlier removal and log transformation | Quantitative (Continuous) |
| **LBXBMN** | Blood manganese (µg/dL) | Quantitative (Continuous) |
| **LBXBMN_clean_log** | Blood manganese (µg/dL) after outlier removal and log transformation | Quantitative (Continuous) |
| **BPXSY1** | Systolic BP, first reading | Quantitative (Integer) |
| **BPXSY1_clean** | Systolic BP, first reading, after outlier removal | Quantitative (Integer) |
| **BPXDI1** | Diastolic BP, first reading | Quantitative (Integer) |
| **BPXDI1_clean** | Diastolic BP, first reading, after outlier removal | Quantitative (Integer) |

Summary statistics for the continuous and categorical variables:

Table 2: Summary of numeric data.

| Variable     | mean   | stdev | median | min   | max    |
|:-------------|:-------|:------|:-------|:------|:-------|
| **RIDAGEYR** | 53.67  | 7.54  | 55.00  | 40.00 | 65.00  |
| **LBXBPB**   | 1.36   | 1.69  | 1.02   | 0.12  | 42.48  |
| **LBXBCD**   | 0.53   | 0.60  | 0.34   | 0.07  | 7.50   |
| **LBXBMN**   | 10.07  | 3.78  | 9.39   | 1.57  | 35.56  |
| **BPXSY1**   | 127.95 | 18.52 | 126.00 | 78.00 | 224.00 |
| **BPXDI1**   | 76.06  | 12.04 | 76.00  | 0.00  | 124.00 |

Table 3: Summary of categorical data.

| Variable                            | Count (Percent) |
|:------------------------------------|:----------------|
| **RIAGENDR: Sex**                   |                 |
| Male                                | 975 (48.39%)    |
| Female                              | 1040 (51.61%)   |
| **RIDRETH1: Race**                  |                 |
| Mexican American                    | 303 (15.03%)    |
| Other Hispanic                      | 208 (10.32%)    |
| Non-Hispanic White                  | 581 (28.83%)    |
| Non-Hispanic Black                  | 483 (23.97%)    |
| Other Race - Including Multi-Racial | 440 (21.84%)    |

## Codebook (HTML Rendering)

```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(labelled)
library(dataReporter)

# Assign variable labels
var_labels <- c(
  SEQN = "Subject ID: Individual Identifier",
  RIDAGEYR = "Age in years at screening (40-65)",
  RIAGENDR = "Sex: male or female",
  RIDRETH1 = "Race / Ethnicity",
  LBXBPB = "Blood lead (µg/dL)",
  LBXBPB_clean_log = "Blood lead after outlier removal and log transformation",
  LBXBCD = "Blood cadmium (µg/dL)",
  LBXBCD_clean_log = "Blood cadmium after outlier removal and log transformation",
  LBXBMN = "Blood manganese (µg/dL)",
  LBXBMN_clean_log = "Blood manganese after outlier removal and log transformation",
  BPXSY1 = "Systolic BP, first reading",
  BPXSY1_clean = "Systolic BP, first reading after outlier removal",
  BPXDI1 = "Diastolic BP, first reading",
  BPXDI1_clean = "Diastolic BP, first reading after outlier removal"
)

# Convert your named character vector to a named list
var_labels_list <- as.list(var_labels)

# Apply labels to the dataframe
nhanes_clean <- set_variable_labels(nhanes_clean, .labels = var_labels_list)


makeCodebook(nhanes_clean, file = here::here("data/study1/codebook.html"), output = "html", replace = TRUE)
```

## Codebook (Table Rendering)

```{r}
library(dplyr)
library(purrr)
library(tibble)

# Numeric variables codebook
numeric_codebook <- nhanes_clean %>%
  select(where(is.numeric)) %>%
  map_dfr(~{
    tibble(
      type = class(.x)[1],
      missing = sum(is.na(.x)),
      min = min(.x, na.rm = TRUE),
      q25 = quantile(.x, 0.25, na.rm = TRUE),
      median = median(.x, na.rm = TRUE),
      mean = mean(.x, na.rm = TRUE),
      q75 = quantile(.x, 0.75, na.rm = TRUE),
      max = max(.x, na.rm = TRUE)
    )
  }, .id = "variable")


# Display results
print(numeric_codebook, n = Inf)

```

```{r}
# Categorical variables codebook
categorical_codebook <- nhanes_clean %>%
  select(where(~is.factor(.x) || is.character(.x))) %>%
  map_dfr(~{
    unique_vals <- unique(.x)
    tibble(
      type = class(.x)[1],
      missing = sum(is.na(.x)),
      n_unique = length(unique_vals),
      levels = paste(head(unique_vals, 10), collapse = ", ") # show first 10
    )
  }, .id = "variable")

# Display results
print(categorical_codebook, n = Inf)

```

```{r}
# categorical codebook -- easier to see
categorical_vars <- c("RIAGENDR", "RIDRETH1")

categorical_summary <- lapply(categorical_vars, function(var) {
  nhanes_clean %>%
    group_by(.data[[var]]) %>%
    summarise(
      count = n(),
      .groups = "drop"
    ) %>%
    mutate(
      variable = var,
      missing = sum(is.na(nhanes_clean[[var]]))
    ) %>%
    select(variable, level = .data[[var]], count, missing)
}) %>%
  bind_rows()

categorical_summary
```

## Analytic Tibble

```{r}
head(nhanes_clean)

```

# Summary Statistics

```{r}
library(psych)

# numeric variables
describe(nhanes_clean)
```

```{r}
# Categorical variables
library(dplyr)
library(tidyr)

# List of categorical variables to summarize
cat_vars <- c("RIAGENDR", "RIDRETH1")

# Function to summarize one categorical variable
summarize_cat <- function(var_name, data) {
  data %>%
    count(.data[[var_name]]) %>%
    mutate(
      Proportion = n / sum(n),
      variable = var_name,
      level = .data[[var_name]]
    ) %>%
    select(variable, level, n, Proportion)
}

# Loop over variables and combine
cat_summary <- lapply(cat_vars, summarize_cat, data = nhanes_clean) %>%
  bind_rows()

cat_summary
```

# Study 1 Analyses

## Analysis B: Comparing 2 Means with Independent Samples (Blood Lead Levels by Sex)

**Question:** Is the blood lead level different in males and females?

**Dataset Description:** The dataset was stratified by sex. Mean blood lead levels (LBXBPB_clean_log), were compared between the two sexes (male, female). There were 769 males and 821 females in the dataset.

**Main analysis:** A two-tailed t-test was used to compare the difference in mean blood lead levels (log-transformed) between males and females. A significance level of 0.1 was used. The effect size (Cohen's d) was also computed (small: 0.2, medium: 0.5, large: 0.8). This set-up is essentially equivalent to univariate OLS, where the beta coefficient ($\beta_1$) corresponds to the difference in means of the two groups and the intercept ($\beta_0$) corresponds to the mean lead concentration of the reference group. OLS assumes that the data (or rather, the errors) follow a normal distribution, the errors are independent, and the errors have a constant variance. 
$$log(lead\_conc) = \beta_0 + \beta_1(male\_sex)$$ 
$$lead\_conc = e^{\beta_0 + \beta_1(male\_sex)}$$
$$\text{Fold change }lead\_conc = e^{\beta_1}$$

**Conclusions:** The median blood lead level was 0.71 ± 0.25 (mean ± SD) for males and 0.65 ± 0.25 for females, which translates to a 6% (difference in means: 0.71-0.65 = 0.06 $\rightarrow$ fold change: $e^{0.06} = 1.06$, $\rightarrow$ 6% increase) difference in blood lead concentrations between males and females. The difference was statistically significant at the 0.1 level, but the effect size was low (0.26). I conclude that males and females have no appreciable difference in blood lead levels.

```{r}
# I'm only using the blood lead levels for the write-up, but I repeated the other analyses for the dashboard

library(dplyr)
library(rstatix)


# Run t-test
t_res <- nhanes_clean %>%
  t_test(as.formula(paste("LBXBPB_clean_log", "~", "RIAGENDR")))

# Calculate effect size (Cohen's d)
d_res <- nhanes_clean %>%
  cohens_d(as.formula(paste("LBXBPB_clean_log", "~", "RIAGENDR")))

# Compute mean and SD by group
group_stats <- nhanes_clean %>%
  group_by(.data[["RIAGENDR"]]) %>%
  summarise(
    n = n(),
    mean = mean(.data[["LBXBPB_clean_log"]], na.rm = TRUE),
    sd = sd(.data[["LBXBPB_clean_log"]], na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = "RIAGENDR",
    values_from = c(n, mean, sd),
    names_sep = "_"
  )

# Combine results
summary_tbl <- group_stats %>%
  mutate(
    t_statistic = round(t_res$statistic, 3),
    p_value = t_res$p,
    cohen_d = round(d_res$effsize, 3)
  )

summary_tbl

```

## Analysis C: Comparing Blood Lead Levels Across Races

**Question:** Are blood lead levels different between races?

**Dataset Description:** The dataset was stratified by race (Mexican American, other Hispanic, non-Hispanic white, non-Hispanic black, other/multiracial). Mean blood levels of lead (LBXBPB_clean_log), were compared across the 5 racial/ethnic groups. There were 459 individuals identifying as non-Hispanic white, 249 individuals identifying as Mexican American, 179 as other Hispanic, 376 as non-Hispanic black, and 327 as other/multiracial.

**Main analysis:** Race/ethnicity was dummy-coded. A multivariate OLS model was used to compare mean blood lead levels, setting non-Hispanic white as the reference group. A significance level of 0.1 was used. This set-up is similar to an ANOVA followed by post-hoc testing. OLS assumes that the errors are iid, follow a normal distribution with a mean of 0, and have constant variance.

**Conclusions:** The mean blood lead level was 0.64 ± 0.25 (mean ± SD) for non-Hispanic whites, 0.66 ± 0.24 for Mexican Americans, 0.59 ± 0.24 for other Hispanics, 0.71 ± 0.26 for blacks, and 0.74 ± 0.24 for multiracial individuals. This translates into a 1.7% increase in blood lead levels in Mexican Americans compared to non-Hispanic whites, a 5.2% decrease in other Hispanics, a 6.23% increase in black individuals, and a 10.0% increase in blood lead levels multiracial individuals. All the comparisons were statistically significant except for Mexican Americans, whose blood lead levels were closer to the reference group. In conclusion,

```{r}
# Compute mean blood lead per group
group_means <- nhanes_clean %>%
  group_by(RIDRETH1) %>%
  summarise(
    mean_LBXBPB_log = mean(LBXBPB_clean_log, na.rm = TRUE),
    sd_LBXBPB_log   = sd(LBXBPB_clean_log, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) %>%
  #filter(RIDRETH1 != "Non-Hispanic White") %>% # exclude reference if desired
  rename(group = RIDRETH1)

# Combine model results with group means
group_means
```

```{r}
# Ensure RIDRETH1 is a factor
nhanes_clean <- nhanes_clean %>%
  mutate(
    RIDRETH1 = factor(RIDRETH1)
  )

# Set non-Hispanic White as the reference group
nhanes_clean$RIDRETH1 <- relevel(nhanes_clean$RIDRETH1, ref = "Non-Hispanic White")


# Linear regression predicting log-transformed blood lead
model <- lm(LBXBPB_clean_log ~ RIDRETH1, data = nhanes_clean)

# Summarize results
summary(model)

```

```{r}
# Exponentiate coefficients to interpret them on the original scale

# Tidy the model output
tidy_tbl <- tidy(model) %>%
  filter(term != "(Intercept)") %>%  # remove intercept
  # Exponentiate coefficients for interpretation on original scale
  mutate(
    fold_change = exp(estimate),
    percent_change = (fold_change-1)*100,
    # Clean up term names for group labels
    group = gsub("RIDRETH1", "", term)
  ) %>%
  select(group, fold_change, percent_change) %>%
  arrange(factor(group, levels = c("Mexican American", "Other Hispanic", "Non-Hispanic Black", "Other/Multiracial")))

tidy_tbl
```

# Analysis D: Analyzing a 2x2 table
**Question:** Is the proportion of adults with high systolic blood pressure (>140 mmHg) different between males and females?

**Dataset Description:** There were 769 males and 821 females in the dataset. There were 280 individuals with high systolic BP and 1310 individuals with normal-low systolic BP. The exposure or grouping variable is sex (male/female). The outcome variable is high blood pressure (Yes/No). (It doesn't quite make sense to think of sex as an "exposure", but if we had something like "smoking" or "adverse childhood experiences" here, we could easily consider them exposures.) Of the males, 139 have high blood pressure, and 630 don't. Of the females, 141 have high blood pressure, and 680 don't. Ideally, this analysis would also be stratified by age (as males and females might have a different age distribution, and age is correlated with high BP), but that's outside the scope of this analysis.

**Main analysis:** A two-way contingency table was used to determine the frequency of adverse outcomes (high systolic blood pressure) across the two exposure groups, and a chi squared test was used to assess statistical significance. A significance level of 0.1 was used. The null hypothesis is that high BP is equally likely in males and females, and the two variables (sex and high BP) are independent. In other words, the joint probability is the product of the marginal probabilities: $P(\text{male and high BP}) = P(male) \times P(\text{high BP})$. The expected counts for the 2x2 contingency table are derived from the joint probabilities under the assumption of independence (expected counts = joint probability * n). The null hypothesis will be rejected if the actual counts different significantly from the expected counts, meaning that the marginal probabilities are not independent. The chi squared test assumes that variables are categorical. Expected counts should be >5 for each cell (if not, a Fisher's exact test should be used).

**Conclusions:** X-squared = 0.16451, df = 1, p-value = 0.685. We fail to reject the null hypothesis, meaning that we have no evidence to suggest that males and females have different rates of high blood pressure in our sample.

```{r}
# Binarize systolic BP into high (>140) and normal/low (<= 140)
nhanes_clean <- nhanes_clean %>%
  mutate(
    
    HighBP = ifelse(BPXSY1_clean > 140, "Yes", "No")
  )

# 2x2 Contingency Table to analyze exposures (or in this case, high BP) between two groups (male and female sex)
tab <- table(nhanes_clean$RIAGENDR, nhanes_clean$HighBP)  # assuming HighBP = yes/no

# Chi-squared test
chisq.test(tab)

# Odds ratio
library(epitools)
oddsratio(tab)

```

# Analysis E: Analyzing a 5x2 Contingency Table 

**Question:** Is the proportion of adults with high systolic blood pressure (>140 mmHg) different between different racial and ethnic groups?

**Dataset Description:** There were 459 individuals identifying as non-Hispanic white, 249 individuals identifying as Mexican American, 179 as other Hispanic, 376 as non-Hispanic black, and 327 as other/multiracial. There were 280 individuals with high systolic BP and 1310 individuals with normal-low systolic BP. 

**Main analysis:** A chi square test was used to assess whether the probability of having high systolic BP is different across different racial/ethnic groups. The null hypothesis is that the probability of adults having high BP is the same across all racial/ethnic groups (the expected counts don't all have to be the same because we have a different number of people from each racial/ethnic group, but they all have the same probability of having high BP). A significance level of 0.1 was used.

**Conclusions:** The probability of having high systolic blood pressure does differ slightly by racial and ethnic group (X-squared = 23.096, df = 4, p-value = 0.0001211, Cramer's V = 0.1205, indicating a small effect size). The actual difference is not very large, but it is statistically significant due to the large sample size. Non-Hispanic whites have disproportionately lower proportion of individuals with high systolic BP (Pearson residual < -2), while non-Hispanic blacks have a disproportionately higher proportion of people with high BP (Pearson residual > 2).

```{r, echo=TRUE, message=FALSE, warning=FALSE}
tab <- table(nhanes_clean$RIDRETH1, nhanes_clean$HighBP)  # Race x BP category
chisq_res <- chisq.test(tab)
chisq_res

# Cramer's V
library(rcompanion)
cramerV(tab)
```
```{r}
# look at chi square Pearson residuals: (observed - expected)/(sqrt expected)
chisq_res$residuals
```
